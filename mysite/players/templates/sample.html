<html>
<head>
    <link rel=stylesheet type=text/css href="/static/style.css">
    <link type="text/css" href="/static/skin/jplayer.blue.monday.css" rel="stylesheet" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.jplayer.min.js"></script>
    <!--Draggable jquery UI shit-->
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
</head>

<body>
    <div class="head">
      <div class="user_info">
        {% if request.user.is_authenticated %}
          <a href="{% url logout %}">Log Out</a>
	  <br />What's up <b style="color:#00CCCC">{{ request.user }}</b> ?!
        {% else %}
        <form name="input" action="{% url login %}" method="post">
          {% csrf_token %}
          <div class="user">
            Username: <input type="text" name="user" />
          </div>
    	    <div class="pword">
            Password: <input type="password" name="password" />
          </div>
          <div class="button">
            <input type="submit" value="Submit" />
          </div>
        </form>
	<div class="register">Sign up <a href="register">here</a>!</div>
        {% endif %}
      </div>
    </div>
    {% if request.user.is_authenticated %}
    <div class="playlist">
        Make a <a href="new">new playlist</a>!
    </div>
    {% endif %}
    <div class="logo"><a href="{% url home %}"></a></div>
    <div class="search">
        <form method="get">
	    	<label for="query"> Search:</label>
	        <input id="query" name="keywords" type="text" value="{{ request.GET.keywords }}">
		 	<input type="submit" value="Submit">
		</form>
    </div>
    <div class="wrapper">
    <div class="blogroll">
        <ul>
	   <li><h3>Blogroll</h3></li>
           <li><a href="http://www.moteldemoka.com">Motel de Moka</a></li>
	   <li><a href="http://www.20jazzfunkgreats.co.uk/wordpress/">20 Jazz Funk Greats</a></li>
	   <li><a href="http://www.iguessimfloating.net/">I Guess I'm Floating</a></li>
	   <li><a href="http://www.music.for-robots.com/">Music For Robots</a></li>
	   <li><a href="http://www.3hive.com/">3hive</a></li>
	   <li><a href="http://www.unpianomusic.com/">Unpiano Music</a></li>
	   <li><a href="http://www.gimmetinnitus.com/">Gimme Tinnitus</a></li>
	   <li><a href="http://www.fluxblog.org/">Fluxblog</a></li>
	   <li><a href="http://www.undertheradarmag.com/media/">Under the Radar</a></li>
	   <li><a href="http://www.mustard-relics.com/">Mustard Relics</a></li>
	   <li><a href="h:ttp://www.xlr8r.com/mp3">XLR8R</a></li>
        </ul>
    </div>

    <div class="black-box">
        <div id="black-bar">
      <!-- player start -->
          <div id="jquery_jplayer" class="jp-jplayer"></div>
            <div id="jp_container" class="jp-audio">
              <div class="jp-type-single">
                <div class="jp-gui jp-interface">
                  <ul class="jp-controls">
                    <li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
                    <li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
                    <li><a href="javascript:;" class="jp-stop" tabindex="1">stop</a></li>
                    <li><a href="javascript:;" class="jp-mute" tabindex="1" title="mute">mute</a></li>
                    <li><a href="javascript:;" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
                    <li><a href="javascript:;" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
                  </ul>
                <div class="jp-progress">
                  <div class="jp-seek-bar">
                    <div class="jp-play-bar"></div>
                  </div>
                </div>
              <div class="jp-volume-bar">
                <div class="jp-volume-bar-value"></div>
              </div>
              <div class="jp-time-holder">
                <div class="jp-current-time"></div>
                <div class="jp-duration"></div>
                 <ul class="jp-toggles">
                   <li><a href="javascript:;" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
                   <li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
                 </ul>
              </div>
            </div>
            <div class="jp-title">
              <ul>
                <li></li>
              </ul>
            </div>
            <div class="jp-no-solution">
              <span>Update Required</span>
              To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
            </div>
          </div>
        </div>
        <!-- player ends -->
        </div>
      
        <ul id="songlist">
        </ul>
        

    </div>
    
    <div class="next"><a href="/next/{{ page.id }}/">Next Page</a></div>

    {% if request.user.is_authenticated %}
    {% if request.user.playlist_set.all %}
    
    <div class="playlist-links">
        <ul>
            <li><h3>Playlists</h3></li>
            {% for playlist in all_playlists %}
                <li><a href="/playlist/{{playlist.id}}/">{{ playlist.name }}</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endif %}
    </div>
</body>

<!--Making players-->

<script type="text/javascript">
var songs = {{json_songs|safe}};
var player = null;

var set_title = function(artist, song_name) {
    $("div.jp-title ul li").text(artist + " :: " + song_name);
};

var current_song = null;

var load_song = function(song) {
    set_title(song.fields.artist, song.fields.name);
    player.jPlayer("setMedia", {"mp3": song.fields.url });
    player.jPlayer("play");
};

var play_next = function() {
    if (current_song.el.index() == songs.length-1) {
        return;
    }
    else {
        for (var i = 0; i < songs.length; i++) {
            load_song(songs[current_song.el.index()+1]);
	}
    }
};

var make_song_div = function(song, track_order) {
    var container = $("<li>");
    song['el'] = container;
    container.addClass("song");
    //container.draggable({ snap: true, containment: "parent", zIndex: 100});
    container.attr("track_order", track_order);

    var artist = $("<div>");
    artist.text(song.fields.artist);
    artist.addClass("artist");

    var name = $("<div>");
    name.text(song.fields.name);
    name.addClass("name");

    var playbutton = $("<a href=''>");
    playbutton.text("Play");

    var play_fn = function() {
        load_song(song);
        current_song = song;
        load_song(song);
        return false;
    }

    playbutton.click(play_fn);
    
    container.append(artist);
    container.append(name);
    container.append(playbutton);
    

    $("ul#songlist").append(container);    
};


var move_song = function(start, end) {
    moving_song = songs[start];
    if (start < end) {
        for (var i = start; i < end; i++) {
            songs[i] = songs[i+1];
            songs[i].el.attr("track_order", i);
        }
    } else {
        for (var i = start; i > end; i--) {
            songs[i] = songs[i-1];
            songs[i].el.attr("track_order", i);

        }    
    }
    songs[end] = moving_song;
    moving_song.el.attr("track_order", end);
}


var preload_player = function() {
    var target = "#jquery_jplayer";
    var css_target = "#jp_container";

    $(target).jPlayer({
        ready: function() {
            var first_song = songs[0];
            current_song = first_song;
            player = $(this);
            player.jPlayer("setMedia", {"mp3": songs[0].fields.url})
            set_title(first_song.fields.artist, first_song.fields.name);
        },
        ended: play_next,
        cssSelectorAncestor: css_target,
        swfPath: "/static/js",
        supplied: "mp3",
        preload: "none",
        errorAlerts: false,
        warningAlerts: false
    });

    for (var i = 0; i < songs.length; i++) {
        make_song_div(songs[i], i);
    }
};


var sortsongs = function(evt, ui_evt) {
    new_pos = ui_evt.item.index();
    old_pos = Number(ui_evt.item.attr("track_order"));
    move_song(old_pos, new_pos);
};

var main = function() {
    preload_player();
    $("#songlist").sortable(
    {"stop": sortsongs});
    $("#songlist").disableSelection();
};

$(document).ready(main);

</script>
</html>
